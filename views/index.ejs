<%- include('partials/header') %>

<style>
  .home-hero{
    background: radial-gradient(1200px 600px at -10% 10%, #e0f2fe 0%, transparent 50%),
                radial-gradient(1000px 500px at 110% -10%, #e6f7ff 0%, transparent 55%),
                #f6f9ff;
    position: relative;
  }
  .room-card{ transition:.2s transform, .2s box-shadow; }
  .room-card:hover{ transform: translateY(-4px); box-shadow: 0 12px 28px rgba(2,132,199,.16); }

  /* City switcher */
  .city-img{ height: 360px; object-fit: cover; border-radius: 16px; }
  .city-chip{ border-radius: 999px; padding: 6px 12px; border:1px solid #bde4ff; background:#e6f7ff; color:#0ea5e9; cursor:pointer; }
  .city-chip.active{ background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
</style>

<section class="home-hero overflow-hidden">
  <div class="container py-5">
    <div class="row align-items-center g-4">
      <div class="col-lg-6">
        <h1 class="display-5 fw-bold text-primary-emphasis mb-2">
          Đặt phòng nhanh – đẹp – minh bạch
        </h1>
        <p class="lead text-secondary mb-4">
          Chọn ngày, lọc theo tên phòng/giá/địa điểm và đặt ngay. Giá hiển thị rõ ràng, xác nhận tức thì.
        </p>

        <!-- FORM TÌM KIẾM -->
        <form action="/search" method="get" class="row gy-2 gx-2 bg-white shadow-sm rounded-4 p-3">
          <div class="col-12 col-md-6">
            <label class="form-label small text-muted">Từ khóa (tên/mã/loại/địa điểm)</label>
            <input class="form-control" type="text" name="q" placeholder="Deluxe, D101, Hà Nội...">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small text-muted">Loại phòng</label>
            <input class="form-control" type="text" name="type" placeholder="Deluxe">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small text-muted">Địa điểm</label>
            <input class="form-control" type="text" name="location" placeholder="Hà Nội">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small text-muted">Giá từ</label>
            <input class="form-control" type="number" min="0" name="minPrice" placeholder="500000">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small text-muted">Giá đến</label>
            <input class="form-control" type="number" min="0" name="maxPrice" placeholder="2000000">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small text-muted">Nhận phòng</label>
            <input class="form-control" type="date" name="checkIn" id="checkIn" required>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small text-muted">Trả phòng</label>
            <input class="form-control" type="date" name="checkOut" id="checkOut" required>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label small text-muted">Sắp xếp</label>
            <select class="form-select" name="sort">
              <option value="price_asc">Giá tăng dần</option>
              <option value="price_desc">Giá giảm dần</option>
              <option value="name_asc">Tên A → Z</option>
              <option value="name_desc">Tên Z → A</option>
            </select>
          </div>
          <div class="col-12 col-md-3 d-grid align-self-end">
            <button class="btn btn-info text-white fw-semibold" type="submit">Tìm phòng</button>
          </div>
        </form>
      </div>

      <div class="col-lg-6">
        <div class="ratio ratio-16x9 rounded-4 shadow-lg overflow-hidden">
          <img id="heroImg" src="/images/hotel-banner.jpg" class="w-100 h-100 object-fit-cover"
               alt="Hotel banner" onerror="this.src='/images/001.jpg'">
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ====== CITY SWITCHER ====== -->
<section class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h4 fw-bold text-primary mb-0">Khám phá theo địa điểm: <span id="cityTitle">Hà Nội</span></h2>
    <div class="d-flex gap-2 flex-wrap">
      <button type="button" class="city-chip js-city-btn active" data-city="Hà Nội" data-img="/images/001.jpg">Hà Nội</button>
      <button type="button" class="city-chip js-city-btn" data-city="Đà Nẵng" data-img="/images/002.jpg">Đà Nẵng</button>
      <button type="button" class="city-chip js-city-btn" data-city="TP. Hồ Chí Minh" data-img="/images/005.jpg">TP.HCM</button>
      <button type="button" class="city-chip js-city-btn" data-city="Phú Quốc" data-img="/images/006.jpg">Phú Quốc</button>
    </div>
  </div>

  <img id="cityImg" class="w-100 city-img shadow-sm" src="/images/001.jpg" alt="City">
</section>

<!-- ====== FEATURED ROOMS ====== -->
<section class="bg-white py-5">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="h4 fw-bold text-primary">Phòng nổi bật</h2>
      <span class="badge rounded-pill px-3 py-2 bg-info-subtle text-info fw-semibold">
        Còn <span id="roomCount"><%= (rooms && rooms.length) || 0 %></span> phòng khả dụng
      </span>
    </div>

    <div id="featuredGrid" class="row g-4">
      <% if (rooms && rooms.length) { %>
        <% rooms.forEach(r => { %>
          <div class="col-sm-6 col-lg-4">
            <a href="/user/room/<%= r._id %>" class="text-decoration-none text-dark">
              <div class="card h-100 border-0 shadow-sm rounded-4 room-card">
                <img
                  src="<%= r.image && r.image.startsWith('/images/') ? r.image : (r.image ? '/images/' + r.image : '/images/room1.jpeg') %>"
                  class="card-img-top rounded-top-4" style="height:220px;object-fit:cover"
                  alt="<%= r.name || r.type || 'Room' %>"
                  onerror="this.src='/images/room1.jpeg'">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between">
                    <h3 class="h6 fw-bold mb-0"><%= r.name || (r.type + ' - ' + r.roomNumber) %></h3>
                    <span class="badge <%= (r.status==='available'?'bg-success-subtle text-success':'bg-secondary') %>">
                      <%= r.status || 'available' %>
                    </span>
                  </div>
                  <p class="small text-muted mb-2"><%= r.location || '—' %></p>
                  <div class="d-flex align-items-center justify-content-between">
                    <span class="fw-bold text-info"><%= (r.price||0).toLocaleString() %>₫/đêm</span>
                    <span class="small text-muted"><%= r.type || '' %></span>
                  </div>
                </div>
              </div>
            </a>
          </div>
        <% }) %>
      <% } else { %>
        <div class="col-12 text-muted">Hiện chưa có phòng khả dụng.</div>
      <% } %>
    </div>
  </div>
</section>

<!-- ====== CTA ====== -->
<section class="py-5" style="background: linear-gradient(135deg,#0ea5e9,#2563eb);">
  <div class="container">
    <div class="row align-items-center g-4">
      <div class="col-lg-8">
        <h2 class="h4 fw-bold text-white mb-1">Sẵn sàng cho kỳ nghỉ tiếp theo?</h2>
        <p class="mb-0 text-white-50">Tìm phòng phù hợp và đặt ngay chỉ với vài cú nhấp chuột.</p>
      </div>
      <div class="col-lg-4 text-lg-end">
        <a href="/search?checkIn=&checkOut=" class="btn btn-light fw-semibold px-4">Bắt đầu tìm kiếm</a>
      </div>
    </div>
  </div>
</section>

<%- include('partials/footer') %>

<script>
  // Giới hạn ngày
  (function(){
    const today = new Date().toISOString().split('T')[0];
    const inEl = document.getElementById('checkIn');
    const outEl = document.getElementById('checkOut');
    if(inEl){ inEl.min = today; }
    if(outEl){ outEl.min = today; }
    if(inEl && outEl){ inEl.addEventListener('change', ()=> { outEl.min = inEl.value || today; }); }
  })();

  // Render card phòng
  function renderRoomCard(r){
    const img = r.image || '/images/room1.jpeg';
    const name = r.name || (r.type ? (r.type + ' - ' + (r.roomNumber || '')) : 'Room');
    const statusBadge = (r.status === 'available') ? 'badge bg-success-subtle text-success' : 'badge bg-secondary';
    return `
      <div class="col-sm-6 col-lg-4">
        <a href="/user/room/${r._id}" class="text-decoration-none text-dark">
          <div class="card h-100 border-0 shadow-sm rounded-4 room-card">
            <img src="${img}" class="card-img-top rounded-top-4" style="height:220px;object-fit:cover"
                 alt="${name}" onerror="this.src='/images/room1.jpeg'">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <h3 class="h6 fw-bold mb-0">${name}</h3>
                <span class="${statusBadge}">${r.status || 'available'}</span>
              </div>
              <p class="small text-muted mb-2">${r.location || '—'}</p>
              <div class="d-flex align-items-center justify-content-between">
                <span class="fw-bold text-info">${(r.price||0).toLocaleString()}₫/đêm</span>
                <span class="small text-muted">${r.type || ''}</span>
              </div>
            </div>
          </div>
        </a>
      </div>`;
  }

  async function switchCity(city, imgUrl){
    document.getElementById('cityTitle').textContent = city;
    const hero = document.getElementById('heroImg');
    const cityImg = document.getElementById('cityImg');
    if (hero) hero.src = imgUrl;
    if (cityImg) cityImg.src = imgUrl;

    try {
      const res = await fetch(`/api/rooms?location=${encodeURIComponent(city)}&limit=9`, { cache: 'no-store' });
      const data = await res.json();
      const grid = document.getElementById('featuredGrid');
      const countEl = document.getElementById('roomCount');

      if (data && data.ok) {
        const rooms = data.rooms || [];
        countEl.textContent = rooms.length.toString();
        grid.innerHTML = rooms.length
          ? rooms.map(renderRoomCard).join('')
          : `<div class="col-12 text-muted">Không tìm thấy phòng tại ${city}.</div>`;
      } else {
        grid.innerHTML = `<div class="col-12 text-muted">Không tải được phòng. Vui lòng thử lại.</div>`;
      }
    } catch (e) { console.error(e); }
  }

  // Gắn sự kiện click cho các nút city
  document.querySelectorAll('.js-city-btn').forEach(btn => {
    btn.addEventListener('click', function(){
      document.querySelectorAll('.js-city-btn').forEach(x => x.classList.remove('active'));
      this.classList.add('active');
      switchCity(this.dataset.city, this.dataset.img);
    });
  });

  // Preload ảnh để chuyển mượt
  ['001.jpg','002.jpg','005.jpg','006.jpg'].forEach(name => { const img = new Image(); img.src = `/images/${name}`; });
</script>
